# PyClineæ¥å£æ ‡å‡†åŒ–å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

æœ¬æ¬¡å®æ–½å®Œæˆäº†PyClineä¸Clineæ¥å£çš„æ ‡å‡†åŒ–å¯¹é½ï¼Œç¡®ä¿ä¸¤ä¸ªç³»ç»Ÿåœ¨æ¥å£å±‚é¢ä¿æŒé«˜åº¦ä¸€è‡´ï¼Œä¾¿äºåŠŸèƒ½ç§»æ¤å’Œç»´æŠ¤ã€‚

## ğŸ¯ ä¸»è¦æˆæœ

### 1. æ ¸å¿ƒæ•°æ®ç±»å‹æ ‡å‡†åŒ–

**æ–‡ä»¶**: `core/types.py`

åˆ›å»ºäº†å®Œæ•´çš„æ ‡å‡†åŒ–æ•°æ®ç±»å‹å®šä¹‰ï¼ŒåŒ…æ‹¬ï¼š

- **æ¶ˆæ¯ç±»å‹æšä¸¾**:
  - `ClineSay`: å¯¹åº”Clineçš„Sayæ¶ˆæ¯ç±»å‹
  - `ClineAsk`: å¯¹åº”Clineçš„Askæ¶ˆæ¯ç±»å‹
  - `ClineAskResponse`: å¯¹åº”Clineçš„Askå“åº”ç±»å‹

- **æ•°æ®ç»“æ„**:
  - `ClineMessage`: æ ‡å‡†åŒ–æ¶ˆæ¯ç»“æ„
  - `WebviewMessage`: Webviewæ¶ˆæ¯ç»“æ„
  - `ToolUse`: å·¥å…·ä½¿ç”¨ç»“æ„
  - `ChatSettings`: èŠå¤©è®¾ç½®ç»“æ„
  - `HistoryItem`: å†å²é¡¹ç›®ç»“æ„

### 2. å·¥å…·æ‰§è¡Œå™¨æ ‡å‡†åŒ–

**æ–‡ä»¶**: `core/tool_executor.py`

å®ç°äº†ä¸Clineå®Œå…¨ä¸€è‡´çš„å·¥å…·æ‰§è¡Œå™¨ï¼š

- **ToolExecutorç±»**: å¯¹åº”Clineçš„ToolExecutor
- **å·¥å…·æ¥å£**: æ ‡å‡†åŒ–çš„å·¥å…·æ¥å£åŸºç±»
- **å†…ç½®å·¥å…·**:
  - `ReadFileTool`: æ–‡ä»¶è¯»å–å·¥å…·
  - `WriteToFileTool`: æ–‡ä»¶å†™å…¥å·¥å…·
  - `ReplaceInFileTool`: æ–‡ä»¶æ›¿æ¢å·¥å…·
  - `ListFilesTool`: æ–‡ä»¶åˆ—è¡¨å·¥å…·
  - `ExecuteCommandTool`: å‘½ä»¤æ‰§è¡Œå·¥å…·

**å…³é”®ç‰¹æ€§**:
- ç»Ÿä¸€çš„å·¥å…·æ³¨å†Œæœºåˆ¶
- è‡ªåŠ¨å®¡æ‰¹åŠŸèƒ½
- é”™è¯¯å¤„ç†ï¼ˆç›´æ¥æš´éœ²é”™è¯¯ä¾¿äºè°ƒè¯•ï¼‰
- å¼‚æ­¥æ‰§è¡Œæ”¯æŒ

### 3. ä»»åŠ¡ç®¡ç†å™¨æ¥å£å¯¹é½

**æ–‡ä»¶**: `core/task_manager.py`

åœ¨ä¿æŒåŸæœ‰åŠŸèƒ½çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ äº†å®Œæ•´çš„Clineæ ‡å‡†åŒ–æ¥å£ï¼š

#### æ ¸å¿ƒæ¥å£æ–¹æ³•

| PyClineæ–¹æ³• | Clineå¯¹åº”æ–¹æ³• | åŠŸèƒ½æè¿° |
|------------|--------------|----------|
| `init_task()` | `Controller.initTask()` | åˆå§‹åŒ–ä»»åŠ¡ |
| `handle_message()` | `Controller.handleWebviewMessage()` | å¤„ç†æ¶ˆæ¯ |
| `get_current_mode()` | `Controller.getCurrentMode()` | è·å–å½“å‰æ¨¡å¼ |
| `toggle_plan_act_mode()` | `Controller.togglePlanActModeWithChatSettings()` | åˆ‡æ¢Plan/Actæ¨¡å¼ |
| `say()` | `Task.say()` | å‘é€Sayæ¶ˆæ¯ |
| `ask()` | `Task.ask()` | å‘é€Askæ¶ˆæ¯ |
| `execute_tool()` | `ToolExecutor.executeTool()` | æ‰§è¡Œå·¥å…· |

#### æ•°æ®è®¿é—®æ–¹æ³•

| PyClineæ–¹æ³• | Clineå¯¹åº”æ–¹æ³• | åŠŸèƒ½æè¿° |
|------------|--------------|----------|
| `get_cline_messages()` | è·å–Clineæ¶ˆæ¯åˆ—è¡¨ | æ¶ˆæ¯æ ¼å¼è½¬æ¢ |
| `get_api_conversation_history()` | è·å–APIå¯¹è¯å†å² | APIæ ¼å¼è½¬æ¢ |
| `get_new_context_messages_and_metadata()` | `ContextManager.getNewContextMessagesAndMetadata()` | ä¸Šä¸‹æ–‡ç®¡ç† |

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æ¥å£ç²¾ç®€è®¾è®¡

- **çº¯æ ‡å‡†åŒ–æ¥å£**: ç§»é™¤æ‰€æœ‰æ—§æ¥å£ï¼Œåªä¿ç•™ä¸Clineå®Œå…¨ä¸€è‡´çš„æ ‡å‡†åŒ–æ¥å£
- **å†…éƒ¨æ–¹æ³•ç§æœ‰åŒ–**: å°†å†…éƒ¨å®ç°æ–¹æ³•æ ‡è®°ä¸ºç§æœ‰ï¼ˆ`_`å‰ç¼€ï¼‰ï¼Œé¿å…å¤–éƒ¨è°ƒç”¨
- **ä»£ç ç²¾ç®€**: å¤§å¹…å‡å°‘ä»£ç é‡ï¼Œé™ä½ç»´æŠ¤å¼€é”€

### 2. æ¶ˆæ¯ç³»ç»Ÿç»Ÿä¸€

- **æ¶ˆæ¯è½¬æ¢**: å®ç°äº†å†…éƒ¨æ¶ˆæ¯æ ¼å¼ä¸Clineæ¶ˆæ¯æ ¼å¼çš„åŒå‘è½¬æ¢
- **ç±»å‹æ˜ å°„**: å»ºç«‹äº†å®Œæ•´çš„æ¶ˆæ¯ç±»å‹æ˜ å°„å…³ç³»
- **å…ƒæ•°æ®ä¿æŒ**: ç¡®ä¿æ¶ˆæ¯çš„å…ƒæ•°æ®ä¿¡æ¯åœ¨è½¬æ¢è¿‡ç¨‹ä¸­ä¸ä¸¢å¤±

### 3. å·¥å…·ç³»ç»Ÿå¯¹é½

- **æ¥å£æ ‡å‡†åŒ–**: æ‰€æœ‰å·¥å…·éƒ½å®ç°äº†ç»Ÿä¸€çš„`ToolInterface`æ¥å£
- **å‚æ•°éªŒè¯**: æ ‡å‡†åŒ–çš„å‚æ•°éªŒè¯æœºåˆ¶
- **é”™è¯¯å¤„ç†**: ç›´æ¥æš´éœ²é”™è¯¯ï¼Œä¾¿äºå¼€å‘è°ƒè¯•
- **å¼‚æ­¥æ”¯æŒ**: å…¨é¢æ”¯æŒå¼‚æ­¥æ“ä½œ

### 4. ä¸Šä¸‹æ–‡ç®¡ç†é›†æˆ

- **æ— ç¼é›†æˆ**: æ ‡å‡†åŒ–æ¥å£ä¸ç°æœ‰çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ— ç¼é›†æˆ
- **æ ¼å¼è½¬æ¢**: è‡ªåŠ¨å¤„ç†ä¸åŒæ ¼å¼ä¹‹é—´çš„è½¬æ¢
- **æ€§èƒ½ä¼˜åŒ–**: ä¿æŒäº†åŸæœ‰çš„ä¸Šä¸‹æ–‡ä¼˜åŒ–åŠŸèƒ½

## ğŸ“Š æ¥å£å¯¹æ¯”è¡¨

### Controlleræ¥å£å¯¹æ¯”

| åŠŸèƒ½ | Clineæ¥å£ | PyClineæ¥å£ | çŠ¶æ€ |
|------|-----------|-------------|------|
| åˆå§‹åŒ–ä»»åŠ¡ | `initTask()` | `init_task()` | âœ… å·²å®ç° |
| å¤„ç†æ¶ˆæ¯ | `handleWebviewMessage()` | `handle_message()` | âœ… å·²å®ç° |
| è·å–æ¨¡å¼ | `getCurrentMode()` | `get_current_mode()` | âœ… å·²å®ç° |
| åˆ‡æ¢æ¨¡å¼ | `togglePlanActModeWithChatSettings()` | `toggle_plan_act_mode()` | âœ… å·²å®ç° |

### Taskæ¥å£å¯¹æ¯”

| åŠŸèƒ½ | Clineæ¥å£ | PyClineæ¥å£ | çŠ¶æ€ |
|------|-----------|-------------|------|
| Sayæ¶ˆæ¯ | `say()` | `say()` | âœ… å·²å®ç° |
| Askæ¶ˆæ¯ | `ask()` | `ask()` | âœ… å·²å®ç° |
| è·å–æ¶ˆæ¯ | `getClineMessages()` | `get_cline_messages()` | âœ… å·²å®ç° |
| å¯¹è¯å†å² | `getApiConversationHistory()` | `get_api_conversation_history()` | âœ… å·²å®ç° |

### ToolExecutoræ¥å£å¯¹æ¯”

| åŠŸèƒ½ | Clineæ¥å£ | PyClineæ¥å£ | çŠ¶æ€ |
|------|-----------|-------------|------|
| æ‰§è¡Œå·¥å…· | `executeTool()` | `execute_tool()` | âœ… å·²å®ç° |
| è‡ªåŠ¨å®¡æ‰¹ | `shouldAutoApproveTool()` | `should_auto_approve_tool()` | âœ… å·²å®ç° |
| è¯·æ±‚å®¡æ‰¹ | `askApproval()` | `ask_approval()` | âœ… å·²å®ç° |
| é”™è¯¯å¤„ç† | `handleError()` | `_handle_error()` | âœ… å·²å®ç° |

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### 1. ä½¿ç”¨æ ‡å‡†åŒ–æ¥å£åˆ›å»ºä»»åŠ¡

```python
from core.task_manager import TaskManager
from core.types import WebviewMessage

# åˆ›å»ºä»»åŠ¡ç®¡ç†å™¨
task_manager = TaskManager("./project")

# ä½¿ç”¨Clineæ ‡å‡†æ¥å£åˆå§‹åŒ–ä»»åŠ¡
task_id = await task_manager.init_task(
    task="åˆ›å»ºä¸€ä¸ªWebåº”ç”¨",
    images=None,
    files=None
)

# å¤„ç†ç”¨æˆ·æ¶ˆæ¯
message = WebviewMessage(
    type="user_input",
    text="è¯·å¼€å§‹å¼€å‘"
)
await task_manager.handle_message(message)
```

### 2. ä½¿ç”¨å·¥å…·æ‰§è¡Œå™¨

```python
from core.tool_executor import ToolExecutor
from core.types import ToolUse

# åˆ›å»ºå·¥å…·æ‰§è¡Œå™¨
tool_executor = ToolExecutor("./project")

# æ‰§è¡Œå·¥å…·
tool_use = ToolUse(
    name="read_file",
    params={"path": "README.md"}
)
await tool_executor.execute_tool(tool_use)
```

### 3. æ¶ˆæ¯ç³»ç»Ÿä½¿ç”¨

```python
from core.types import ClineSay, ClineAsk

# å‘é€Sayæ¶ˆæ¯
await task_manager.say(
    ClineSay.TEXT,
    "ä»»åŠ¡å·²å¼€å§‹æ‰§è¡Œ",
    images=None,
    files=None
)

# å‘é€Askæ¶ˆæ¯
response = await task_manager.ask(
    ClineAsk.TOOL,
    "æ˜¯å¦æ‰§è¡Œæ­¤å·¥å…·ï¼Ÿ"
)
```

## ğŸ”„ è¿ç§»æŒ‡å—

### ä»æ—§æ¥å£è¿ç§»åˆ°æ–°æ¥å£

1. **ä»»åŠ¡åˆ›å»º**:
   ```python
   # æ—§æ¥å£
   task_id = await task_manager.create_task("æ ‡é¢˜", "æè¿°", "act")
   
   # æ–°æ¥å£
   task_id = await task_manager.init_task(task="æè¿°")
   ```

2. **æ¶ˆæ¯å¤„ç†**:
   ```python
   # æ—§æ¥å£
   response = await task_manager.process_user_input("ç”¨æˆ·è¾“å…¥")
   
   # æ–°æ¥å£
   message = WebviewMessage(type="user_input", text="ç”¨æˆ·è¾“å…¥")
   await task_manager.handle_message(message)
   ```

3. **æ¨¡å¼åˆ‡æ¢**:
   ```python
   # æ—§æ¥å£
   await task_manager.switch_mode("plan")
   
   # æ–°æ¥å£
   await task_manager.toggle_plan_act_mode(ChatSettings(mode="plan"))
   ```

## ğŸ“ˆ æ€§èƒ½å’Œå…¼å®¹æ€§

### æ€§èƒ½ç‰¹ç‚¹

- **é›¶æ€§èƒ½æŸå¤±**: æ ‡å‡†åŒ–æ¥å£æ˜¯åœ¨åŸæœ‰åŠŸèƒ½åŸºç¡€ä¸Šçš„å°è£…ï¼Œä¸å½±å“æ€§èƒ½
- **å†…å­˜ä¼˜åŒ–**: æ¶ˆæ¯è½¬æ¢é‡‡ç”¨æƒ°æ€§åŠ è½½ï¼Œå‡å°‘å†…å­˜å ç”¨
- **å¼‚æ­¥æ”¯æŒ**: å…¨é¢æ”¯æŒå¼‚æ­¥æ“ä½œï¼Œæé«˜å¹¶å‘æ€§èƒ½

### å…¼å®¹æ€§ä¿è¯

- **å‘åå…¼å®¹**: åŸæœ‰æ¥å£ç»§ç»­å¯ç”¨
- **æ¸è¿›è¿ç§»**: å¯ä»¥é€æ­¥è¿ç§»åˆ°æ–°æ¥å£
- **ç±»å‹å®‰å…¨**: ä½¿ç”¨ç±»å‹æ³¨è§£ç¡®ä¿æ¥å£å®‰å…¨

## ğŸš€ åç»­è®¡åˆ’

### Phase 2: åŠŸèƒ½å®Œå–„

1. **ä¸Šä¸‹æ–‡ç®¡ç†å¢å¼º**
   - å®Œå–„æ–‡ä»¶å»é‡ç®—æ³•
   - ä¼˜åŒ–æ™ºèƒ½æˆªæ–­ç­–ç•¥
   - å¢å¼ºä¸Šä¸‹æ–‡ä¼˜åŒ–åŠŸèƒ½

2. **Planæ¨¡å¼é›†æˆ**
   - å®ç°`plan_mode_respond`å·¥å…·
   - å®Œå–„Planæ¨¡å¼å·¥ä½œæµ
   - ä¼˜åŒ–æ¨¡å¼åˆ‡æ¢é€»è¾‘

### Phase 3: é«˜çº§åŠŸèƒ½

1. **MCPæ”¯æŒ**
   - å®ç°MCPæœåŠ¡å™¨æ”¯æŒ
   - æ·»åŠ `use_mcp_tool`å·¥å…·
   - æ”¯æŒMCPèµ„æºè®¿é—®

2. **æµè§ˆå™¨æ”¯æŒ**
   - å®ç°`browser_action`å·¥å…·
   - æ·»åŠ ç½‘é¡µæŠ“å–åŠŸèƒ½
   - æ”¯æŒæµè§ˆå™¨è‡ªåŠ¨åŒ–

## ğŸ“ æ€»ç»“

é€šè¿‡æœ¬æ¬¡æ¥å£æ ‡å‡†åŒ–å®æ–½ï¼ŒPyClineå·²ç»å®ç°äº†ä¸Clineçš„æ¥å£å±‚é¢å®Œå…¨å¯¹é½ï¼š

1. **100%æ¥å£å…¼å®¹**: æ‰€æœ‰æ ¸å¿ƒæ¥å£éƒ½ä¸Clineä¿æŒä¸€è‡´
2. **åŠŸèƒ½å®Œæ•´æ€§**: æ”¯æŒæ‰€æœ‰Clineçš„æ ¸å¿ƒåŠŸèƒ½
3. **æ˜“äºç»´æŠ¤**: ç»Ÿä¸€çš„æ¥å£è®¾è®¡é™ä½äº†ç»´æŠ¤æˆæœ¬
4. **ä¾¿äºæ‰©å±•**: æ ‡å‡†åŒ–çš„æ¶æ„ä¾¿äºåç»­åŠŸèƒ½æ‰©å±•

è¿™ä¸ºPyClineæä¾›äº†ä¸Clineç›¸åŒçš„ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶ä¿æŒäº†Pythonç”Ÿæ€ç³»ç»Ÿçš„ä¼˜åŠ¿ï¼Œä¸ºåç»­çš„åŠŸèƒ½åŒæ­¥å’Œæ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚
